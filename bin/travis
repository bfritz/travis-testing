#!/bin/bash -x

set -e

WATCHDOG_PID=""
function find_sbt_pid() {
    pgrep -f "java.*sbt.*goToSleep"
}

function start_watchdog() {
    echo "Watchdog will wake up in $1"
    (sleep "$1" && echo "Watchdog launched jstack." && jstack $(find_sbt_pid)) &
    WATCHDOG_PID=$(pgrep --newest sleep)
}

function stop_watchdog() {
    [ -n "$WATCHDOG_PID" ] && kill "$WATCHDOG_PID"
}


start_watchdog 20s
sbt goToSleep
stop_watchdog
